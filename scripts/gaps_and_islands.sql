/*
	Relationship sequences
	
*/ 

;WITH DT AS
(
	SELECT 'AAA' AS C1, '123' AS C2, '2019-03-01' AS REL_DATE UNION ALL
	SELECT 'AAA' AS C1, '123' AS C2, '2019-03-02' AS REL_DATE UNION ALL
	SELECT 'AAA' AS C1, '123' AS C2, '2019-03-03' AS REL_DATE UNION ALL
	SELECT 'AAA' AS C1, '456' AS C2, '2019-03-04' AS REL_DATE UNION ALL
	SELECT 'AAA' AS C1, '123' AS C2, '2019-03-05' AS REL_DATE UNION ALL
	SELECT 'AAA' AS C1, '123' AS C2, '2019-03-06' AS REL_DATE UNION ALL
	SELECT 'AAA' AS C1, '123' AS C2, '2019-03-07' AS REL_DATE UNION ALL

	SELECT 'BBB' AS C1, '123' AS C2, '2019-03-01' AS REL_DATE UNION ALL
	SELECT 'BBB' AS C1, '123' AS C2, '2019-03-02' AS REL_DATE UNION ALL
	SELECT 'BBB' AS C1, '123' AS C2, '2019-03-03' AS REL_DATE UNION ALL
	SELECT 'BBB' AS C1, '123' AS C2, '2019-03-04' AS REL_DATE UNION ALL
	SELECT 'BBB' AS C1, '123' AS C2, '2019-03-05' AS REL_DATE UNION ALL
	SELECT 'BBB' AS C1, '123' AS C2, '2019-03-06' AS REL_DATE UNION ALL
	
	SELECT 'CCC' AS C1, '123' AS C2, '2019-03-01' AS REL_DATE UNION ALL
	SELECT 'CCC' AS C1, '456' AS C2, '2019-03-02' AS REL_DATE
), SEQUENCES AS
(
	SELECT C1, 
           C2, 
		   REL_DATE, 
		   DATEDIFF(D, '2000-01-01', REL_DATE) AS DT_DIFF,
		   ROW_NUMBER() OVER (PARTITION BY C1, C2 ORDER BY REL_DATE ASC) AS RN,
		   DATEDIFF(D, '2000-01-01', REL_DATE) - ROW_NUMBER() OVER (PARTITION BY C1, C2 ORDER BY REL_DATE ASC) AS GRP
	  FROM DT
)
SELECT C1, C2, MIN(REL_DATE) REL_START, MAX(REL_DATE) REL_END, COUNT(1) REL_DURATION
  FROM SEQUENCES
 GROUP BY C1, C2, GRP
 ORDER BY 1, 3